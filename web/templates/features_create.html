{% extends "base.html" %}
{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css">
  <style>
    .row { display:flex; gap:16px; }
    .col { flex:1; }
    .counter { float:right; color:#64748b; font-size: 13px; }
    .hint { color:#64748b; font-size: 13px; margin-bottom:8px; }
    .label { font-weight:600; margin:10px 0 6px; }
    #grid { height: 420px; }
    .progress { display:none; margin:8px 0; }
    .progress .bar { width:100%; height:4px; background:#e5e7eb; position:relative; border-radius: 2px; overflow:hidden; }
    .progress .bar::after { content:''; position:absolute; left:0; top:0; height:4px; width:20%; background:#2563eb; animation: slide 1s infinite; }
    @keyframes slide { 0%{ left:0 } 50%{ left:80% } 100%{ left:0 } }
  </style>
{% endblock %}
{% block content %}
<h2>Feature Creation</h2>
<form method="post">
  <div class="hint">Enter details in no more than 500 characters.</div>
  <span class="counter" id="charCounter">0/500</span>
  <label>Requirement</label>
  <textarea name="requirement" id="reqInput" maxlength="500">{{ text }}</textarea>
  <p><button type="button" id="genBtn">Generate Feature</button></p>
</form>

<div class="progress" id="progress"><div class="bar"></div></div>

<div id="error" class="flash" style="display:none"></div>

<div id="gridWrap" style="margin-top:8px;">
  <div class="label">Feature</div>
  <div class="ag-theme-quartz" id="grid"></div>
  <p><button id="createJiraBtn" disabled>Create JIRA</button></p>
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
  <script>
    const gridEl = document.getElementById('grid');
    let gridApi = null;
    const gridOptions = {
      theme: 'legacy',
      rowSelection: 'multiple',
      columnDefs: [
        { headerName: '', checkboxSelection: true, headerCheckboxSelection: true, width: 40 },
        { headerName: 'Title', field: 'title', flex: 1 },
        { headerName: 'Description', field: 'description', flex: 2 },
        { headerName: 'Acceptance Criteria', field: 'acceptance', flex: 2 },
        { headerName: 'Benefit Hypothesis', field: 'benefit', flex: 1 },
        { headerName: 'T-Shirt Size', field: 'size', width: 120 },
        { headerName: 'Priority', field: 'priority', width: 120 },
        { headerName: 'Business Value', field: 'businessValue', width: 140 },
        { headerName: 'Due Date', field: 'dueDate', width: 140 },
        { headerName: 'Type', field: 'issue_type', width: 100 }
      ],
      defaultColDef: { resizable: true, sortable: true },
      rowData: []
    };
    if (window.agGrid && gridEl) {
      if (typeof agGrid.createGrid === 'function') {
        gridApi = agGrid.createGrid(gridEl, gridOptions);
      } else if (typeof agGrid.Grid === 'function') {
        new agGrid.Grid(gridEl, gridOptions);
        gridApi = gridOptions.api;
      }
    }
    const progress = document.getElementById('progress');
    const errorEl = document.getElementById('error');
    function showError(msg){ if(!errorEl) return; errorEl.textContent = msg; errorEl.style.display = 'block'; }
    function clearError(){ if(!errorEl) return; errorEl.textContent = ''; errorEl.style.display = 'none'; }
    const genBtn = document.getElementById('genBtn');
    const createBtn = document.getElementById('createJiraBtn');
    if (createBtn) { createBtn.disabled = true; }
    genBtn.addEventListener('click', async () => {
      const req = document.getElementById('reqInput').value.trim();
      clearError();
      if (!req) { showError('Enter requirement'); return; }
      if (req.length > 500) { showError('Enter details in no more than 500 characters'); return; }
      progress.style.display = 'block';
      genBtn.disabled = true; genBtn.textContent = 'Generatingâ€¦';
      if (createBtn) { createBtn.disabled = true; }
      try {
        const res = await fetch('/api/features/generate', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ requirement: req })
        });
        const raw = await res.text();
        let data = null; try { data = JSON.parse(raw); } catch(_) {}
        if (!res.ok) {
          const msg = (data && data.error) || raw || `Error generating (${res.status})`;
          showError(`${msg}. Please retry again.`);
          return;
        }
        if (!gridApi) {
          if (window.agGrid && gridEl) {
            if (typeof agGrid.createGrid === 'function') {
              gridApi = agGrid.createGrid(gridEl, gridOptions);
            } else if (typeof agGrid.Grid === 'function') {
              new agGrid.Grid(gridEl, gridOptions);
              gridApi = gridOptions.api;
            }
          }
        }
        const rows = Array.isArray(data.rows) ? data.rows : [];
        if (gridApi && typeof gridApi.setGridOption === 'function') {
          gridApi.setGridOption('rowData', rows);
        } else if (gridOptions.api && typeof gridOptions.api.setRowData === 'function') {
          gridOptions.api.setRowData(rows);
        }
        if (createBtn) { createBtn.disabled = rows.length === 0; }
        clearError();
      } catch (e) {
        showError('Error generating. Please retry again.');
      } finally {
        progress.style.display = 'none';
        genBtn.disabled = false; genBtn.textContent = 'Generate Feature';
      }
    });
    function getSelectedRows(){
      if (gridApi && typeof gridApi.getSelectedRows === 'function') return gridApi.getSelectedRows();
      if (gridOptions.api && typeof gridOptions.api.getSelectedRows === 'function') return gridOptions.api.getSelectedRows();
      return [];
    }
    document.getElementById('createJiraBtn').addEventListener('click', () => {
      if (createBtn) { createBtn.disabled = true; }
      progress.style.display = 'block';
      const sel = getSelectedRows();
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/features/create_jira';
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'payload';
      input.value = JSON.stringify(sel);
      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    });
  </script>
 </div>

<script>
  const input = document.getElementById('reqInput');
  const counter = document.getElementById('charCounter');
  function update(){ counter.textContent = (input.value || '').length + '/500'; }
  input.addEventListener('input', update);
  update();
</script>
{% endblock %}
