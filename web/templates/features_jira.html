{% extends "base.html" %}
{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css">
  <style>
    .hint { color:#64748b; font-size: 13px; margin-bottom:8px; }
    #grid { height: 420px; }
    textarea { width:100%; min-height: 120px; }
    .progress { display:none; margin:8px 0; }
    .progress .bar { width:100%; height:4px; background:#e5e7eb; position:relative; border-radius: 2px; overflow:hidden; }
    .progress .bar::after { content:''; position:absolute; left:0; top:0; height:4px; width:20%; background:#2563eb; animation: slide 1s infinite; }
    @keyframes slide { 0%{ left:0 } 50%{ left:80% } 100%{ left:0 } }
    .label { font-weight:600; margin:10px 0 6px; }
  </style>
{% endblock %}
{% block content %}
<h2>Feature Creation From JIRA</h2>
<div class="hint">JQL</div>
<textarea id="jqlInput" placeholder="project = SCRUM AND issuetype = Feature ORDER BY created DESC"></textarea>
<p>
  <button id="fetchBtn">Fetch</button>
  <button id="genBtn" disabled>Generate Feature</button>
  <button id="createJiraBtn" disabled>Create JIRA</button>
  </p>

<div class="progress" id="progress"><div class="bar"></div></div>
<div id="error" class="flash" style="display:none"></div>

<div class="label">Requirement</div>
<div class="ag-theme-quartz" id="grid" style="overflow:auto"></div>
<div class="label">Feature</div>
<div class="ag-theme-quartz" id="featGrid" style="margin-top:12px; height: 420px;"></div>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
<script>
  const gridEl = document.getElementById('grid');
  const errorEl = document.getElementById('error');
  const progress = document.getElementById('progress');
  const genBtn = document.getElementById('genBtn');
  const createJiraBtn = document.getElementById('createJiraBtn');
  function showError(msg){ errorEl.textContent = msg; errorEl.style.display = 'block'; }
  function clearError(){ errorEl.textContent = ''; errorEl.style.display = 'none'; }
  let gridApi = null;
  const gridOptions = {
    theme: 'legacy',
    rowSelection: 'multiple',
    tooltipShowDelay: 0,
    tooltipHideDelay: 10000,
    columnDefs: [
      { headerName: '', checkboxSelection: true, headerCheckboxSelection: true, width: 40 },
      { headerName: 'Key', field: 'key', width: 120 },
      { headerName: 'Title', valueGetter: (p)=> (p && p.data ? p.data.summary : ''), tooltipValueGetter:(p)=> String((p && p.value) || ''), width: 200 },
      { headerName: 'Summary', field: 'summary', tooltipField: 'summary', width: 240 },
      { headerName: 'Description', field: 'description', flex: 2 },
      { headerName: 'Acceptance Criteria', field: 'acceptance', tooltipField: 'acceptance', width: 240 },
      { headerName: 'Benefit Hypothesis', field: 'benefit', tooltipField: 'benefit', width: 200 },
      { headerName: 'Business Value', field: 'businessValue', width: 140 },
      { headerName: 'Type', field: 'issue_type', width: 120 },
      { headerName: 'Priority', field: 'priority', width: 120 },
      { headerName: 'DOR', field: 'dor', width: 100 },
      { headerName: 'Size', field: 'size', width: 120 },
      { headerName: 'Status', field: 'status', width: 140 },
      { headerName: 'Assignee', field: 'assignee', width: 160 },
      { headerName: 'Reporter', field: 'reporter', width: 160 },
      { headerName: 'Created', field: 'created', width: 180 },
      { headerName: 'Updated', field: 'updated', width: 180 },
      { headerName: 'Due Date', field: 'dueDate', width: 150 },
      { headerName: 'Work Type', field: 'work_type', width: 140 },
      { headerName: 'Size', field: 'size', width: 120 }
    ],
    defaultColDef: { resizable: true, sortable: true, tooltipValueGetter:(p)=> String((p && p.value) || '') },
    rowData: []
  };
  if (window.agGrid && gridEl) {
    if (typeof agGrid.createGrid === 'function') {
      gridApi = agGrid.createGrid(gridEl, gridOptions);
    } else if (typeof agGrid.Grid === 'function') {
      new agGrid.Grid(gridEl, gridOptions);
      gridApi = gridOptions.api;
    }
  }
  const featGridEl = document.getElementById('featGrid');
  let featGridApi = null;
  const featGridOptions = {
    theme: 'legacy',
    rowSelection: 'multiple',
    columnDefs: [
      { headerName: '', checkboxSelection: true, headerCheckboxSelection: true, width: 40 },
      { headerName: 'Title', field: 'title', flex: 1 },
      { headerName: 'Description', field: 'description', flex: 2 },
      { headerName: 'Acceptance Criteria', field: 'acceptance', flex: 2 },
      { headerName: 'Benefit Hypothesis', field: 'benefit', flex: 1 },
      { headerName: 'T-Shirt Size', field: 'size', width: 120 },
      { headerName: 'Priority', field: 'priority', width: 120 },
      { headerName: 'Business Value', field: 'businessValue', width: 140 },
      { headerName: 'Due Date', field: 'dueDate', width: 140 },
      { headerName: 'Type', field: 'issue_type', width: 100 }
    ],
    defaultColDef: { resizable: true, sortable: true },
    rowData: []
  };
  if (window.agGrid && featGridEl) {
    if (typeof agGrid.createGrid === 'function') {
      featGridApi = agGrid.createGrid(featGridEl, featGridOptions);
    } else if (typeof agGrid.Grid === 'function') {
      new agGrid.Grid(featGridEl, featGridOptions);
      featGridApi = featGridOptions.api;
    }
  }
  document.getElementById('fetchBtn').addEventListener('click', async () => {
    clearError(); progress.style.display='block';
    const jql = document.getElementById('jqlInput').value.trim();
    if (!jql) { showError('Enter JQL'); progress.style.display='none'; return; }
    try {
      const res = await fetch('/api/features/jira_search', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ jql }) });
      let data; let raw=''; try { data = await res.json(); } catch(_) { raw = await res.text(); }
      if (!res.ok) { showError((data && data.error) || raw || 'Fetch failed'); return; }
      const rows = Array.isArray(data.rows) ? data.rows : [];
      const buildCols = (rows) => {
        if (!rows || rows.length === 0) return gridOptions.columnDefs;
        const keys = Object.keys(rows[0]);
        const pretty = (k) => String(k).replace(/_/g,' ').replace(/([a-z])([A-Z])/g,'$1 $2').replace(/^\w/, c => c.toUpperCase());
        const texty = new Set(['summary','description','acceptance','benefit']);
        const cols = [{ headerName: '', checkboxSelection: true, headerCheckboxSelection: true, width: 40 }];
        for (const k of keys) {
          cols.push({ headerName: pretty(k), field: k, ...(texty.has(k) ? { flex: 2 } : { width: 140 }) });
        }
        return cols;
      };
      const preferred = ['key','Title','summary','acceptance','benefit','businessValue','priority','dor','size','status'];
      const pretty = (k) => String(k).replace(/_/g,' ').replace(/([a-z])([A-Z])/g,'$1 $2').replace(/^\w/, c => c.toUpperCase());
      const cols = [{ headerName: '', checkboxSelection: true, headerCheckboxSelection: true, width: 40 }];
      const added = new Set();
      const addCol = (field) => {
        if (added.has(field)) return;
        added.add(field);
        if (field === 'Title') {
          cols.push({ headerName:'Title', valueGetter:(p)=> (p&&p.data?p.data.summary:''), tooltipValueGetter:(p)=> String((p&&p.value)||''), width:200 });
          return;
        }
        const cfg = { headerName: pretty(field), field, tooltipField: field, width: 160 };
        if (field === 'summary' || field === 'acceptance' || field === 'benefit' || field === 'description') cfg.width = 240;
        cols.push(cfg);
      };
      const keys = rows[0] ? Object.keys(rows[0]) : [];
      for (const f of preferred) { if (f==='Title' || keys.includes(f)) addCol(f); }
      for (const k of keys) { if (!added.has(k)) addCol(k); }
      if (gridApi && typeof gridApi.destroy === 'function') {
        try { gridApi.destroy(); } catch(_) {}
        gridApi = null;
      }
      try { gridEl.innerHTML = ''; } catch(_) {}
      try {
        gridOptions.columnDefs = cols;
        gridOptions.rowData = rows;
        if (typeof agGrid.createGrid === 'function') {
          gridApi = agGrid.createGrid(gridEl, gridOptions);
        } else {
          new agGrid.Grid(gridEl, gridOptions);
          gridApi = gridOptions.api;
        }
      } catch(_) {
        if (gridOptions.api && typeof gridOptions.api.setColumnDefs === 'function') {
          gridOptions.api.setColumnDefs(cols);
          gridOptions.api.setRowData(rows);
        }
      }
      genBtn.disabled = rows.length === 0;
    } catch(e) { showError('Fetch failed'); }
    finally { progress.style.display='none'; }
  });
  genBtn.addEventListener('click', async () => {
    clearError();
    const sel = (gridApi && typeof gridApi.getSelectedRows === 'function') ? gridApi.getSelectedRows() : (gridOptions.api ? gridOptions.api.getSelectedRows() : []);
    if (!sel || sel.length === 0) { showError('Select JIRA items'); return; }
    const reqs = sel.map(x => (x && x.summary) || '').filter(Boolean);
    if (reqs.length === 0) { showError('No summaries available'); return; }
    progress.style.display='block';
    try {
      const res = await fetch('/api/features/generate_batch', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ requirements: reqs }) });
      let data; let raw=''; try { data = await res.json(); } catch(_) { raw = await res.text(); }
      if (!res.ok) { showError((data && data.error) || raw || 'Generate failed'); return; }
      const rows = Array.isArray(data.rows) ? data.rows : [];
      if (featGridApi && typeof featGridApi.setGridOption === 'function') {
        featGridApi.setGridOption('rowData', rows);
      } else if (featGridOptions.api) {
        featGridOptions.api.setRowData(rows);
      }
      createJiraBtn.disabled = rows.length === 0;
    } catch(e) { showError('Generate failed'); }
    finally { progress.style.display='none'; }
  });
  createJiraBtn.addEventListener('click', () => {
    clearError();
    const api = (featGridApi && typeof featGridApi.getSelectedRows === 'function') ? featGridApi : featGridOptions.api;
    let sel = [];
    if (api && typeof api.getSelectedRows === 'function') {
      sel = api.getSelectedRows();
    } else if (featGridOptions.api && typeof featGridOptions.api.getDisplayedRowCount === 'function') {
      sel = [];
    }
    if (!sel || sel.length === 0) {
      if (featGridOptions.api && typeof featGridOptions.api.getDisplayedRowCount === 'function') {
        const count = featGridOptions.api.getDisplayedRowCount();
        const all = [];
        for (let i = 0; i < count; i++) {
          const rowNode = featGridOptions.api.getDisplayedRowAtIndex(i);
          if (rowNode && rowNode.data) all.push(rowNode.data);
        }
        sel = all;
      }
    }
    if (!sel || sel.length === 0) { showError('No features to create'); return; }
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/features/create_jira';
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'payload';
    input.value = JSON.stringify(sel);
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
  });
</script>
{% endblock %}
