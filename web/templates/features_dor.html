{% extends "base.html" %}
{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css">
  <style>
    .hint { color:#64748b; font-size: 13px; margin-bottom:8px; }
    textarea { width:100%; min-height: 120px; }
    .progress { display:none; margin:8px 0; }
    .progress .bar { width:100%; height:4px; background:#e5e7eb; position:relative; border-radius: 2px; overflow:hidden; }
    .progress .bar::after { content:''; position:absolute; left:0; top:0; height:4px; width:20%; background:#2563eb; animation: slide 1s infinite; }
    @keyframes slide { 0%{ left:0 } 50%{ left:80% } 100%{ left:0 } }
    #jiraGrid, #dorGrid { height: 420px; }
    #jiraGrid { overflow:auto }
    .label { font-weight:600; margin:10px 0 6px; }
    .jqlBar { display:flex; align-items:center; gap:16px; }
    .textareaWrap { position:relative; }
    .counter { position:absolute; right:8px; top:8px; color:#64748b; font-size: 12px; }
  </style>
{% endblock %}
{% block content %}
<h2>Feature DOR Check</h2>
<div class="jqlBar">
  <div class="label">JQL</div>
  <label class="label" style="margin-left:16px"><input type="checkbox" id="useNlp"> Use NLP</label>
  </div>
<div class="textareaWrap">
  <textarea id="jqlInput" maxlength="300" placeholder="project = SCRUM AND issuetype = Feature ORDER BY created DESC"></textarea>
  <span id="jqlCounter" class="counter">0/300</span>
  </div>
<p>
  <button id="fetchBtn">Fetch</button>
  <button id="checkDorBtn" disabled>Check DOR</button>
  <button id="updateJiraBtn" disabled>Update DOR</button>
</p>

<div class="progress" id="progress"><div class="bar"></div></div>
<div id="error" class="flash" style="display:none"></div>

<div class="label">Features</div>
<div class="ag-theme-quartz" id="jiraGrid"></div>
<div class="label">Feature DOR Results</div>
<div class="ag-theme-quartz" id="dorGrid" style="margin-top:12px"></div>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
<script>
  const errorEl = document.getElementById('error');
  const progress = document.getElementById('progress');
  function showError(msg){ errorEl.textContent = msg; errorEl.style.display = 'block'; }
  function clearError(){ errorEl.textContent = ''; errorEl.style.display = 'none'; }

  const jiraGridEl = document.getElementById('jiraGrid');
  let jiraApi = null;
  const jiraCols = [
    { headerName: '', checkboxSelection: true, headerCheckboxSelection: true, width: 40 },
    { headerName: 'Key', field: 'key', width: 120 },
    { headerName: 'Title', valueGetter:(p)=> (p&&p.data?p.data.summary:''), tooltipValueGetter:(p)=> String((p&&p.value)||''), width:200 },
    { headerName: 'Summary', field: 'summary', tooltipField:'summary', width:240 },
    { headerName: 'Description', field: 'description', flex: 2 },
    { headerName: 'Acceptance Criteria', field: 'acceptance', tooltipField:'acceptance', width:240 },
    { headerName: 'Benefit Hypothesis', field: 'benefit', tooltipField:'benefit', width:200 },
    { headerName: 'Business Value', field: 'businessValue', width: 140 },
    { headerName: 'Type', field: 'issue_type', width: 120 },
    { headerName: 'Priority', field: 'priority', width: 120 },
    { headerName: 'DOR', field: 'dor', width: 100 },
    { headerName: 'Size', field: 'size', width: 120 },
    { headerName: 'Status', field: 'status', width: 140 },
    { headerName: 'Work Type', field: 'work_type', width: 140 },
  ];
  const jiraOptions = { theme:'legacy', rowSelection:'multiple', columnDefs:jiraCols, defaultColDef:{resizable:true, sortable:true, tooltipValueGetter:(p)=> String((p&&p.value)||'')}, tooltipShowDelay:0, tooltipHideDelay:10000, rowData:[] };
  if (window.agGrid && jiraGridEl) {
    if (typeof agGrid.createGrid === 'function') { jiraApi = agGrid.createGrid(jiraGridEl, jiraOptions); }
    else { new agGrid.Grid(jiraGridEl, jiraOptions); jiraApi = jiraOptions.api; }
  }

  const dorGridEl = document.getElementById('dorGrid');
  let dorApi = null;
  const esc = (s) => String(s == null ? '' : s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  const dorCols = [
    { headerName: '', checkboxSelection: true, headerCheckboxSelection: true, width: 40 },
    { headerName: 'Key', field: 'key', width: 120 },
    { headerName: 'Summary', field: 'summary', flex: 2 },
    { headerName: 'Score', field: 'score', width: 100 },
    { headerName: 'Status', field: 'status', width: 120 },
    { headerName: 'Reason', field: 'reason', flex: 2, tooltipField: 'reason', cellRenderer: (p) => {
        const v = p && p.value ? String(p.value) : '';
        const t = esc(v);
        const s = t.length > 160 ? t.slice(0,160) + 'â€¦' : t;
        return `<span title="${t}">${s}</span>`;
      } }
  ];
  const dorOptions = { theme:'legacy', rowSelection:'multiple', columnDefs:dorCols, defaultColDef:{resizable:true, sortable:true}, tooltipShowDelay: 0, tooltipHideDelay: 10000, rowData:[] };
  if (window.agGrid && dorGridEl) {
    if (typeof agGrid.createGrid === 'function') { dorApi = agGrid.createGrid(dorGridEl, dorOptions); }
    else { new agGrid.Grid(dorGridEl, dorOptions); dorApi = dorOptions.api; }
  }

  const fetchBtn = document.getElementById('fetchBtn');
  const checkDorBtn = document.getElementById('checkDorBtn');
  const updateJiraBtn = document.getElementById('updateJiraBtn');

  fetchBtn.addEventListener('click', async () => {
    clearError(); progress.style.display='block';
    let jql = document.getElementById('jqlInput').value.trim();
    const useNlp = document.getElementById('useNlp');
    if (useNlp && useNlp.checked) {
      if (!jql) { showError('Enter query'); progress.style.display='none'; return; }
      try {
        const r = await fetch('/api/jira/nlp_to_jql', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: jql }) });
        const raw = await r.text();
        let dj = null; try { dj = JSON.parse(raw); } catch(_) {}
        if (!r.ok) { showError((dj && dj.error) || raw || 'NLP conversion failed'); progress.style.display='none'; return; }
        jql = String((dj && dj.jql) || '').trim();
        if (!jql) { showError('Empty JQL after NLP'); progress.style.display='none'; return; }
        try { document.getElementById('jqlInput').value = jql; } catch(_) {}
      } catch(e) { showError(String(e && e.message) || 'NLP conversion failed'); progress.style.display='none'; return; }
    } else {
      if (!jql) { showError('Enter JQL'); progress.style.display='none'; return; }
    }
    try {
      const res = await fetch('/api/features/jira_search', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ jql }) });
      const raw = await res.text();
      let data = null; try { data = JSON.parse(raw); } catch(_) {}
      if (!res.ok) { showError((data && data.error) || raw || 'Fetch failed'); return; }
      const rows = Array.isArray(data.rows) ? data.rows : [];
      const buildCols = (rows) => {
        if (!rows || rows.length === 0) return jiraCols;
        const keys = Object.keys(rows[0]);
        const pretty = (k) => String(k).replace(/_/g,' ').replace(/([a-z])([A-Z])/g,'$1 $2').replace(/^\w/, c => c.toUpperCase());
        const texty = new Set(['summary','description','acceptance','benefit','reason']);
        const cols = [{ headerName: '', checkboxSelection: true, headerCheckboxSelection: true, width: 40 }];
        for (const k of keys) {
          cols.push({ headerName: pretty(k), field: k, ...(texty.has(k) ? { flex: 2 } : { width: 140 }) });
        }
        return cols;
      };
      const preferred = ['key','Title','summary','acceptance','benefit','businessValue','priority','dor','size','status'];
      const pretty = (k) => String(k).replace(/_/g,' ').replace(/([a-z])([A-Z])/g,'$1 $2').replace(/^\w/, c => c.toUpperCase());
      const cols = [{ headerName: '', checkboxSelection: true, headerCheckboxSelection: true, width: 40 }];
      const added = new Set();
      const addCol = (field) => {
        if (added.has(field)) return;
        added.add(field);
        if (field === 'Title') {
          cols.push({ headerName:'Title', valueGetter:(p)=> (p&&p.data?p.data.summary:''), tooltipValueGetter:(p)=> String((p&&p.value)||''), width:200 });
          return;
        }
        const cfg = { headerName: pretty(field), field, tooltipField: field, width: 160 };
        if (field === 'summary' || field === 'acceptance' || field === 'benefit' || field === 'description') cfg.width = 240;
        cols.push(cfg);
      };
      const keys = rows[0] ? Object.keys(rows[0]) : [];
      for (const f of preferred) { if (f==='Title' || keys.includes(f)) addCol(f); }
      for (const k of keys) { if (!added.has(k)) addCol(k); }
      if (jiraApi && typeof jiraApi.destroy === 'function') {
        try { jiraApi.destroy(); } catch(_) {}
        jiraApi = null;
      }
      try { jiraGridEl.innerHTML = ''; } catch(_) {}
      try {
        jiraOptions.columnDefs = cols;
        jiraOptions.rowData = rows;
        if (typeof agGrid.createGrid === 'function') {
          jiraApi = agGrid.createGrid(jiraGridEl, jiraOptions);
        } else {
          new agGrid.Grid(jiraGridEl, jiraOptions);
          jiraApi = jiraOptions.api;
        }
      } catch(_) {
        // fallback to API updates if recreation fails
        if (jiraOptions.api && typeof jiraOptions.api.setColumnDefs === 'function') {
          jiraOptions.api.setColumnDefs(cols);
          jiraOptions.api.setRowData(rows);
        }
      }
      checkDorBtn.disabled = rows.length === 0;
      if ((useNlp && useNlp.checked) && rows.length === 0) {
        showError('The NLP query did not return any results. Please check the query and correct it.');
      }
      updateJiraBtn.disabled = true;
      if (dorApi && typeof dorApi.setGridOption === 'function') { dorApi.setGridOption('rowData', []); }
      else if (dorOptions.api) { dorOptions.api.setRowData([]); }
    } catch(e) { showError('Fetch failed'); }
    finally { progress.style.display='none'; }
  });

  checkDorBtn.addEventListener('click', async () => {
    clearError();
    const sel = (jiraApi && typeof jiraApi.getSelectedRows === 'function') ? jiraApi.getSelectedRows() : (jiraOptions.api ? jiraOptions.api.getSelectedRows() : []);
    if (!sel || sel.length === 0) { showError('Select JIRA items'); return; }
    progress.style.display='block';
    try {
      const res = await fetch('/api/features/dor_check', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items: sel }) });
      let data; let raw=''; try { data = await res.json(); } catch(_) { raw = await res.text(); }
      if (!res.ok) { showError((data && data.error) || raw || 'DOR check failed'); return; }
      const rows = Array.isArray(data.rows) ? data.rows : [];
      if (dorApi && typeof dorApi.setGridOption === 'function') { dorApi.setGridOption('rowData', rows); }
      else if (dorOptions.api) { dorOptions.api.setRowData(rows); }
      updateJiraBtn.disabled = rows.length === 0;
    } catch(e) { showError('DOR check failed'); }
    finally { progress.style.display='none'; }
  });

  updateJiraBtn.addEventListener('click', async () => {
    clearError();
    let passKeys = [];
    let failKeys = [];
    const collect = (api) => {
      if (!api || typeof api.forEachNode !== 'function') return false;
      try {
        api.forEachNode(n => {
          const r = n && n.data ? n.data : {};
          const k = r && r.key ? String(r.key) : '';
          const status = String(r && r.status || '').toUpperCase();
          const score = Number(r && r.score || 0);
          if (!k) return;
          if (status === 'PASS' || score >= 85) passKeys.push(k);
          else failKeys.push(k);
        });
        return true;
      } catch(_) { return false; }
    };
    if (!collect(dorApi)) collect(dorOptions.api);
    if ((passKeys.length + failKeys.length) === 0) { showError('No DOR results'); return; }
    progress.style.display='block';
    try {
      const res = await fetch('/api/features/jira_update_dor_flag', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ pass_keys: passKeys, fail_keys: failKeys }) });
      let data; let raw=''; try { data = await res.json(); } catch(_) { raw = await res.text(); }
      if (!res.ok) { showError((data && data.error) || raw || 'Update failed'); return; }
      const ok = Array.isArray(data.updated) ? data.updated.length : 0;
      const err = Array.isArray(data.errors) ? data.errors.length : 0;
      showError(`Updated: ${ok}${err? ' | Errors: '+err : ''}`);
    } catch(e) { showError('Update failed'); }
    finally { progress.style.display='none'; }
  });
  const jqlInput = document.getElementById('jqlInput');
  const jqlCounter = document.getElementById('jqlCounter');
  function updateJqlCounter(){ jqlCounter.textContent = (jqlInput.value || '').length + '/300'; }
  jqlInput.addEventListener('input', updateJqlCounter);
  updateJqlCounter();
</script>
{% endblock %}
