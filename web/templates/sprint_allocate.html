{% extends "base.html" %}
{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css">
  <style>
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom: 8px; }
    .row .field { display:flex; flex-direction:column; }
    .hint { color:#64748b; font-size: 13px; }
    .progress { display:none; margin:8px 0; }
    .progress .bar { width:100%; height:4px; background:#e5e7eb; position:relative; border-radius: 2px; overflow:hidden; }
    .progress .bar::after { content:''; position:absolute; left:0; top:0; height:4px; width:20%; background:#2563eb; animation: slide 1s infinite; }
    @keyframes slide { 0%{ left:0 } 50%{ left:80% } 100%{ left:0 } }
    .label { font-weight:600; margin:10px 0 6px; display:flex; align-items:center; justify-content:space-between; }
    .export-btn { background:#e6f0ff; border:1px solid #cfe0ff; color:#0f172a; padding:4px 8px; border-radius:8px; cursor:pointer; font-size:12px; }
    .cap { margin-left:8px; font-weight:500; color:#0f172a; }
    #storiesGrid { height: 480px; }
    .ag-row.suggested { background: #fff8e1 !important; }
  </style>
{% endblock %}
{% block content %}
<h2>Allocate Stories to Sprint</h2>
<div id="error" class="flash" style="display:none"></div>

<div class="row">
  <div class="field"><div class="hint">Sprint Name</div>
    <select id="sprintSelect"></select>
  </div>
  <div class="field" style="align-self:flex-end"><button id="loadSprintBtn">Load Capacity</button></div>
  <div class="field"><div class="hint">Available Capacity</div><input id="availCapVal" type="number" step="0.01" disabled></div>
  <div class="field"><div class="hint">Velocity</div><input id="velocity" type="number" min="0" step="0.1" placeholder="20"></div>
  <div style="align-self:flex-end"><button id="fetchBtn">Fetch Stories</button></div>
  <div style="align-self:flex-end"><button id="suggestBtn" disabled>Suggest</button></div>
  <div class="progress" id="progress"><div class="bar"></div></div>
  </div>

  <div class="label">Stories <button class="export-btn" id="exportStories">â¤“ Export</button></div>
  <div class="ag-theme-quartz" id="storiesGrid"></div>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
<script>
  const errorEl = document.getElementById('error');
  const progress = document.getElementById('progress');
  function showError(msg){ errorEl.textContent = msg; errorEl.style.display = 'block'; }
  function clearError(){ errorEl.textContent = ''; errorEl.style.display = 'none'; }

  const sprintSelect = document.getElementById('sprintSelect');
  const loadSprintBtn = document.getElementById('loadSprintBtn');
  const availCapValEl = document.getElementById('availCapVal');
  const velocityEl = document.getElementById('velocity');
  const fetchBtn = document.getElementById('fetchBtn');
  const suggestBtn = document.getElementById('suggestBtn');
  const allocateBtn = (function(){ const b = document.createElement('button'); b.id = 'allocateBtn'; b.textContent = 'Allocate'; b.disabled = true; b.style.marginLeft = '8px'; try { suggestBtn.parentNode.insertBefore(b, suggestBtn.nextSibling); } catch(_) {} return b; })();
  const storiesGridEl = document.getElementById('storiesGrid');
  let storiesApi = null;

  function priorityRank(p){ try{ const v = String((p && p.name) ? p.name : p || '').toLowerCase(); const map = { 'highest':5, 'high':4, 'medium':3, 'low':2, 'lowest':1 }; return map[v] || 0; }catch(_){ return 0; } }
  function getStoryPoints(r){ try{ if (r == null) return 0; if (typeof r.story_points !== 'undefined') return Number(r.story_points||0); if (typeof r['Story Points'] !== 'undefined') return Number(r['Story Points']||0); if (typeof r.storyPoints !== 'undefined') return Number(r.storyPoints||0); return Number(r.points||0) || 0; }catch(_){ return 0; } }
  function getDor(r){ try{ const v = (r.dor ?? r.DOR ?? r['DOR Flag'] ?? r['DOR']) || ''; return String(v).trim(); }catch(_){ return ''; } }

  const storiesCols = [
    { headerName: '', width: 48, valueGetter:(p)=> !!(p && p.data && p.data.selected), cellRenderer:(p)=>{ const cb = document.createElement('input'); cb.type = 'checkbox'; cb.disabled = true; try { cb.checked = !!p.value; }catch(_){} return cb; } },
    { headerName: 'Key', field: 'key', width: 120 },
    { headerName: 'Summary', field: 'summary', flex: 2 },
    { headerName: 'Priority', field: 'priority', width: 140, valueGetter:(p)=> (p&&p.data?p.data.priority:'') },
    { headerName: 'Story Points', field: 'story_points', width: 140, valueGetter:(p)=> getStoryPoints(p && p.data) },
    { headerName: 'DOR', field: 'dor', width: 100, valueGetter:(p)=> getDor(p && p.data) },
  ];
  const storiesOptions = { theme:'legacy', columnDefs:storiesCols, defaultColDef:{resizable:true, sortable:true}, rowData: [], rowClassRules: { 'suggested': (params)=> !!(params && params.data && params.data.suggest) } };
  if (window.agGrid) {
    if (typeof agGrid.createGrid === 'function') { storiesApi = agGrid.createGrid(storiesGridEl, storiesOptions); }
    else { new agGrid.Grid(storiesGridEl, storiesOptions); storiesApi = storiesOptions.api; }
  }

  async function loadSprintNames(){
    try {
      const res = await fetch('/api/sprint/names');
      let data; let raw=''; try { data = await res.json(); } catch(_) { raw = await res.text(); }
      if (!res.ok) { showError((data && data.error) || raw || 'Load failed'); return; }
      const names = Array.isArray(data.names) ? data.names : [];
      sprintSelect.innerHTML = names.map(n => `<option value="${String(n)}">${String(n)}</option>`).join('');
    } catch(e) { showError('Load failed'); }
  }
  loadSprintNames();

  async function loadCapacity(){
    clearError();
    const name = (sprintSelect.value||'').trim();
    if (!name) { showError('Select sprint'); return; }
    try {
      const res = await fetch('/api/sprint/capacity/get', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
      let data; let raw=''; try { data = await res.json(); } catch(_) { raw = await res.text(); }
      if (!res.ok) { showError((data && data.error) || raw || 'Load failed'); return; }
      const sum = Array.isArray(data.summary) ? data.summary : [];
      let cap = 0; for (const r of sum){ cap += Number(r.available_capacity||0); }
      try { if (availCapValEl) availCapValEl.value = Number(cap.toFixed(2)); } catch(_){ }
    } catch(e) { showError('Load failed'); }
  }
  loadSprintBtn.addEventListener('click', loadCapacity);
  sprintSelect.addEventListener('change', loadCapacity);

  async function fetchBacklog(){
    clearError(); progress.style.display='block';
    const jql = 'Project=SCRUM and issuetype="Story" and DOR="YES" and Sprint is EMPTY';
    try {
      const res = await fetch('/api/stories/jira_search', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ jql }) });
      let data; let raw=''; try { data = await res.json(); } catch(_) { raw = await res.text(); }
      if (!res.ok) { showError((data && data.error) || raw || 'Fetch failed'); return; }
      let rows = Array.isArray(data.rows) ? data.rows : [];
      rows = rows.map(r => ({ ...r, selected:false, suggest:false }));
      if (storiesApi && typeof storiesApi.setGridOption === 'function') storiesApi.setGridOption('rowData', rows);
      else if (storiesOptions.api) storiesOptions.api.setRowData(rows);
      suggestBtn.disabled = rows.length === 0;
      allocateBtn.disabled = true;
    } catch(e) { showError('Fetch failed'); }
    finally { progress.style.display='none'; }
  }
  fetchBtn.addEventListener('click', fetchBacklog);

  function suggest(){
    clearError();
    const rows = [];
    if (storiesApi && typeof storiesApi.forEachNode === 'function') storiesApi.forEachNode(n=>{ if(n&&n.data) rows.push(n.data); });
    const vel = Number(velocityEl.value||0);
    if (!vel || vel <= 0) { showError('Enter Velocity'); return; }
    const sorted = rows.slice().sort((a,b)=>{
      const pa = priorityRank(a.priority), pb = priorityRank(b.priority);
      if (pb !== pa) return pb - pa; // higher priority first
      const sa = getStoryPoints(a), sb = getStoryPoints(b);
      return sa - sb; // lower points first
    });
    let acc = 0; const target = vel * 1.02; // 2% over velocity
    for (const r of sorted){ r.suggest=false; r.selected=false; }
    for (const r of sorted){ const pts = getStoryPoints(r); if (!pts || pts < 0) continue; if (acc >= target) break; r.suggest = true; r.selected = true; acc += pts; }
    try {
      if (storiesApi && typeof storiesApi.setGridOption === 'function') storiesApi.setGridOption('rowData', sorted);
      else if (storiesOptions.api) storiesOptions.api.setRowData(sorted);
    } catch(_) {}
    allocateBtn.disabled = sorted.filter(r=> r.selected).length === 0;
  }
  suggestBtn.addEventListener('click', suggest);

  async function allocate(){
    clearError();
    const name = (sprintSelect.value||'').trim();
    if (!name) { showError('Select sprint'); return; }
    const rows = [];
    if (storiesApi && typeof storiesApi.forEachNode === 'function') storiesApi.forEachNode(n=>{ if(n&&n.data) rows.push(n.data); });
    const keys = rows.filter(r => !!r.selected).map(r => String(r.key||'')).filter(k => k);
    if (!keys.length) { showError('No stories to allocate'); return; }
    progress.style.display='block';
    try {
      const res = await fetch('/api/sprint/allocate_stories', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sprint_name: name, keys }) });
      let data; let raw=''; try { data = await res.json(); } catch(_) { raw = await res.text(); }
      if (!res.ok) { showError((data && data.error) || raw || 'Allocate failed'); return; }
      const cnt = (data && Array.isArray(data.updated)) ? data.updated.length : (Number(data && data.count) || keys.length);
      showError(`Allocated ${cnt} stories to ${name}`);
    } catch(e) { showError('Allocate failed'); }
    finally { progress.style.display='none'; }
  }
  allocateBtn.addEventListener('click', allocate);

  function exportGrid(api, filename){
    try {
      if (api && typeof api.exportDataAsCsv === 'function') { api.exportDataAsCsv({ fileName: filename }); return; }
    } catch(_) {}
    try {
      const rows=[]; if (api && typeof api.forEachNode === 'function') api.forEachNode(n=>{ if(n&&n.data) rows.push(n.data); });
      const cols = Object.keys(rows[0]||{});
      const csv = [cols.join(',')].concat(rows.map(r=> cols.map(c=> JSON.stringify(r[c] ?? '')).join(','))).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename || 'export.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    } catch(e) { showError('Export failed'); }
  }
  document.getElementById('exportStories').addEventListener('click', () => exportGrid(storiesApi || storiesOptions.api, 'sprint-stories.csv'));
</script>
{% endblock %}
